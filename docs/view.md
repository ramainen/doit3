View
====

Класс View необходим, чтобы отображать шаблоны страниц. Работает класс совместно с роутером в единой связке. При этом поведение отличается в зависимости от того, было ли запущен `return`, был ли вывод внутри роута и так далее. Также вывод обычно оборачивается в основной шаблон страницы _main.html, также называемым термином "layout". Этот файл содержит теги `<head>`, `<html>`, шапку сайта, меню и так далее.

Использование View в роутах
-------------------------------

Типовое использование класса `View` следующее:

	<?php
	d()->route('/news/:id',function($id){
		d()->this  = d()->News->find($id); //Получение данных
		return d()->view->render('news.html'); //Вывод шаблона
	});

Более подробно, в частных случаях поведение соответствует следующим правилам:

### return ###

Если роут вернул строковое значение при помощи `return`, то это значение выведется в браузер. Обёрток (_main.html) - не будет (если не вызвать `render()`, см. ниже). Например, если надо просто вывести JSON текст, это самым простым способом можно сделать так:

	<?php
	d()->route('/api/get_server_info',function(){
		return json_encode($_SERVER);
	});

Весь вывод (`print` и так далее) при этом будет проигнорирован.

### print ###

Если в роуте есть вывод текста (при помощи `print`, `echo`, `var_dump()` и так далее), то вывод буферизуется и выводится в браузер. Если кроме вывода ничего нет, то вывод **не** оборачивается в layout (_main.html).

	<?php
	d()->route('/',function(){
		print 'Hello, world!'; //Выводит в браузер два слова
	});
	
	d()->route('/news/:id',function($id){
		var_dump($_SERVER); //Кроме этого, на странице ничего не будет.
	});

Для удобства есть метод класса `View`: `d()->view->partial('file.html')`, который возвращает скомпилированный и запущенный шаблон. Результат можно вывести или поместить в переменную.

	<?php
	d()->route('/news/:id',function($id){
		print d()->view->partial('news.html'); //В данном случае нужен print
	});

`partial()`	не включает в себя основной шаблон страницы (layout), не задает никаких правил, он просто запускает файл шаблона и возвращает готовый HTML.

Можно вывести шаблон на вывод при помощи `return` (например, если это фрагмент веб-страницы, загружаемый через AJAX):

	<?php
	d()->route('/news/:id',function($id){
		return d()->view->partial('news.html'); //Кроме news.html ничего выведено не будет
	});

Если необходимо вставить фрагмент в виде HTML файла внутрь другого шаблона, `partial()` в этом также поможет.
	
### render ###

Основной и самый частый способ использования шаблона.

Если в роуте явно указано `d()->view->render('file.html')`, то в браузер будет выведена страница, обёрнутая в layout (_main.html). Если не вызван метод `render()`, то layout выведен не будет.

`d()->view->render($file)` не осуществляет вывод (не делает `print` в поток вывода). Поэтому надо писать `print d()->view->render()`. Метод `render()` делает две задачи:

* возвращает шаблон на основе файла
* указывает системе, что поверх него необходимо обернуть основной шаблон (layout _main.html).


В качестве первого аргумента в `render()` надо передавать имя html файла:

	<?php
	d()->route('/news/:id',function($id){
		d()->this  = d()->News->find($id);
		print d()->view->render('news.html');
	});

По умолчанию вывод оборачивается в `_main.html`


### render и print ###

Если в роуте есть и `render` и `print`, то оба вывода попадут в общий поток.

	<?php
	d()->route('/news/:id',function($id){
		print 'Hello, World!<br>';
		print d()->view->render('news.html');
	});

По умолчанию вывод оборачивается в _main.html. В середине результата в предназначенном месте будет выведено как "Hello, World!", так и news.html.

Можно подавить весь вывод (`print` и так далее), вызвав `return`. Наличие метода `render()` обязывает систему обернуть вывод в шаблон.

	<?php
	d()->route('/news/:id',function($id){
		d()->this  = d()->News->find($id);
		print 'Hidden text'; //Выведено не будет
		return d()->view->render('news.html'); //print подавлен, шаблон выведен
	});

### Автопоиск файла ###

Если запустить `d()->view->render()` без параметров, имя файла будет подобрано автоматически на основе адреса.

	<?php
	d()->route('/news/:id',function($id){
		d()->this  = d()->News->find($id);
		print d()->view->render();
	});

Если в роуте не было вывода, и он ничего не вернул, то ничего выведено автоматически не будет.


### Layout страницы ###

Layout страницы можно поменять следующими способами:

Способ №1. В шаблоне написать


	{{layout 'index.html'}}

	
Способ №2. В контроллере написать

	d()->view->setLayout('index.html');
	
### Примечания ###


**Q:** Я хочу вывести `var_dump`, или другой вывод, обернуть в layout (_main.html), но шаблона у меня нет. Как вызвать `render()`?

**A:** Выполнить `d()->view->enableLayout()`. Эта команда просто укажет системе, что шаблон-layout вывести надо. В любом случае для страниц должен быть шаблон, для сервисных адресов (api) шаблон не нужен. Держите ваш код в порядке, возможно, он запутанный и стоит его переписать по другому. В целом `print` внутри роута не приветствуется, и следует всегда использовать `return`.


